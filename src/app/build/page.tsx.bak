'use client';

import { useEffect, useState } from 'react';
import { useBuildStore, UserOption, RingOption, Food } from '@/store/buildStore';
import { initializeGameData } from '@/lib/data';
import { JobSelector } from '@/components/JobSelector';
import { LevelInput } from '@/components/LevelInput';
import { SPSlider } from '@/components/SPSlider';
import { EquipmentSlot } from '@/components/EquipmentSlot';
import { StatViewer } from '@/components/StatViewer';
import { EquipSlot, Job, Equipment } from '@/types';
import { FoodData } from '@/types/data';

export default function BuildPage() {
  const [isLoading, setIsLoading] = useState(true);
  const [showAdvancedSettings, setShowAdvancedSettings] = useState(false);
  
  const {
    currentBuild,
    calculatedStats,
    availableJobs,
    availableEquipment,
    availableFoods,
    userOption,
    ringOption,
    selectedFood,
    foodEnabled,
    weaponSkillEnabled,
    setJob,
    setLevel,
    setEquipment,
    setSPAllocation,
    setUserOption,
    setRingOption,
    setFood,
    toggleFood,
    toggleWeaponSkill,
    setAvailableJobs,
    setAvailableEquipment,
    setAvailableFoods,
  } = useBuildStore();

  // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
  useEffect(() => {
    const loadGameData = async () => {
      try {
        const gameData = await initializeGameData();
        
        // è·æ¥­ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›
        const jobs: Job[] = Array.from(gameData.csv.jobs.entries()).map(([name, spData]) => ({
          id: name,
          name: name,
          baseStats: {
            HP: 100,
            MP: 50,
            ATK: 10,
            DEF: 10,
            MATK: 10,
            MDEF: 10,
            AGI: 10,
            DEX: 10,
            LUK: 10,
            CRI: 5,
            HIT: 95,
            FLEE: 10,
          },
          statGrowth: {
            HP: 10,
            MP: 5,
            ATK: 2,
            DEF: 2,
            MATK: 2,
            MDEF: 2,
            AGI: 1,
            DEX: 1,
            LUK: 1,
            CRI: 0,
            HIT: 0,
            FLEE: 0,
          },
          availableWeapons: ['sword', 'staff', 'bow', 'dagger', 'axe'] as any[],
          skills: [],
          maxLevel: 100,
        }));

        // è£…å‚™ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›
        const equipments: Equipment[] = [
          ...gameData.csv.weapons.map(w => ({
            id: w.ã‚¢ã‚¤ãƒ†ãƒ å,
            name: w.ã‚¢ã‚¤ãƒ†ãƒ å,
            slot: 'weapon' as EquipSlot,
            baseStats: [
              { stat: 'ATK' as const, value: w['æ”»æ’ƒåŠ›ï¼ˆåˆæœŸå€¤ï¼‰'] || 0, isPercent: false },
              { stat: 'CRI' as const, value: w['ä¼šå¿ƒç‡ï¼ˆåˆæœŸå€¤ï¼‰'] || 0, isPercent: false },
            ],
            requiredLevel: w.ä½¿ç”¨å¯èƒ½Lv || 1,
            requiredJob: [],
            rarity: w.æœ€ä½ãƒ©ãƒ³ã‚¯ || 'common',
          })),
          ...gameData.csv.armors.map(a => {
            const slotMap: { [key: string]: EquipSlot } = {
              'é ­': 'head',
              'èƒ´': 'body',
              'è…•': 'arm',
              'è„š': 'leg',
            };
            return {
              id: a.ã‚¢ã‚¤ãƒ†ãƒ å,
              name: a.ã‚¢ã‚¤ãƒ†ãƒ å,
              slot: 'body' as EquipSlot, // é˜²å…·éƒ¨ä½ã¯åˆ¥é€”åˆ¤å®šãŒå¿…è¦
              baseStats: [
                { stat: 'DEF' as const, value: a['å®ˆå‚™åŠ›ï¼ˆåˆæœŸå€¤ï¼‰'] || 0, isPercent: false },
                { stat: 'HP' as const, value: a['HPï¼ˆåˆæœŸå€¤ï¼‰'] || 0, isPercent: false },
              ],
              requiredLevel: a.ä½¿ç”¨å¯èƒ½Lv || 1,
              requiredJob: [],
              rarity: a.æœ€ä½ãƒ©ãƒ³ã‚¯ || 'common',
            };
          }),
          ...gameData.csv.accessories.map(a => ({
            id: a.ã‚¢ã‚¤ãƒ†ãƒ å,
            name: a.ã‚¢ã‚¤ãƒ†ãƒ å,
            slot: 'accessory1' as EquipSlot, // ã‚¢ã‚¯ã‚»ã‚µãƒªç¨®åˆ¥ã¯åˆ¥é€”åˆ¤å®šãŒå¿…è¦
            baseStats: [
              { 
                stat: (a.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®é¡ === 'HP' ? 'HP' :
                       a.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®é¡ === 'MP' ? 'MP' :
                       a.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®é¡ === 'æ”»æ’ƒåŠ›' ? 'ATK' :
                       a.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®é¡ === 'å®ˆå‚™åŠ›' ? 'DEF' : 'ATK') as any,
                value: a['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ï¼ˆåˆæœŸå€¤ï¼‰'] || 0, 
                isPercent: false 
              },
            ],
            requiredLevel: a.ä½¿ç”¨å¯èƒ½Lv || 1,
            requiredJob: [],
            rarity: a.æœ€ä½ãƒ©ãƒ³ã‚¯ || 'common',
          })),
        ];

        // é£Ÿã¹ç‰©ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›
        const foods: Food[] = gameData.csv.foods.map(f => ({
          id: f.ã‚¢ã‚¤ãƒ†ãƒ å,
          name: f.ã‚¢ã‚¤ãƒ†ãƒ å,
          effects: [
            ...(f.åŠ¹æœ1 && f.æ•°å€¤1 ? [{
              stat: (f.åŠ¹æœ1 === 'HP' ? 'HP' : 
                     f.åŠ¹æœ1 === 'MP' ? 'MP' :
                     f.åŠ¹æœ1 === 'æ”»æ’ƒåŠ›' ? 'ATK' :
                     f.åŠ¹æœ1 === 'é˜²å¾¡åŠ›' ? 'DEF' :
                     f.åŠ¹æœ1 === 'é­”æ³•æ”»æ’ƒåŠ›' ? 'MATK' :
                     f.åŠ¹æœ1 === 'é­”æ³•é˜²å¾¡åŠ›' ? 'MDEF' : 'ATK') as any,
              value: f.æ•°å€¤1,
              isPercent: f.åŠ¹æœ1.includes('%'),
            }] : []),
            ...(f.åŠ¹æœ2 && f.æ•°å€¤2 ? [{
              stat: (f.åŠ¹æœ2 === 'HP' ? 'HP' : 
                     f.åŠ¹æœ2 === 'MP' ? 'MP' :
                     f.åŠ¹æœ2 === 'æ”»æ’ƒåŠ›' ? 'ATK' :
                     f.åŠ¹æœ2 === 'é˜²å¾¡åŠ›' ? 'DEF' :
                     f.åŠ¹æœ2 === 'é­”æ³•æ”»æ’ƒåŠ›' ? 'MATK' :
                     f.åŠ¹æœ2 === 'é­”æ³•é˜²å¾¡åŠ›' ? 'MDEF' : 'ATK') as any,
              value: f.æ•°å€¤2,
              isPercent: f.åŠ¹æœ2.includes('%'),
            }] : []),
          ],
          duration: f.æŒç¶šæ™‚é–“ || 30,
        }));

        setAvailableJobs(jobs);
        setAvailableEquipment(equipments);
        setAvailableFoods(foods);
        setIsLoading(false);
      } catch (error) {
        console.error('Failed to load game data:', error);
        setIsLoading(false);
      }
    };

    loadGameData();
  }, [setAvailableJobs, setAvailableEquipment, setAvailableFoods]);

  if (isLoading) {
    return (
      <main className="p-8">
        <div className="flex items-center justify-center h-64">
          <p className="text-gray-600 dark:text-gray-400">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </main>
    );
  }

  // è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆã®å®šç¾©
  const equipmentSlots: Array<{ slot: EquipSlot; name: string }> = [
    { slot: 'weapon', name: 'æ­¦å™¨' },
    { slot: 'head', name: 'é ­' },
    { slot: 'body', name: 'èƒ´' },
    { slot: 'arm', name: 'è…•' },
    { slot: 'leg', name: 'è„š' },
    { slot: 'accessory1', name: 'ãƒãƒƒã‚¯ãƒ¬ã‚¹' },
    { slot: 'accessory2', name: 'ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ' },
  ];

  // è·æ¥­ã«å¿œã˜ãŸè£…å‚™å¯èƒ½ãƒ•ã‚£ãƒ«ã‚¿
  const getFilteredEquipment = (slot: EquipSlot): Equipment[] => {
    return availableEquipment.filter(eq => {
      if (eq.slot !== slot) return false;
      if (eq.requiredLevel && currentBuild.level < eq.requiredLevel) return false;
      if (currentBuild.job && eq.requiredJob && eq.requiredJob.length > 0) {
        return eq.requiredJob.includes(currentBuild.job.id);
      }
      return true;
    });
  };

  return (
    <main className="container mx-auto px-4 max-w-7xl">
      {/* Page Header */}
      <div className="mb-12">
        <h1 className="text-5xl md:text-6xl font-thin mb-4 text-gradient from-white to-gray-300">
          ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ“ãƒ«ãƒ‰
        </h1>
        <p className="text-lg text-gray-400 line-clamp-2">
          è·æ¥­ãƒ»è£…å‚™ãƒ»SPã‚’è¨­å®šã—ã¦ã€æœ€å¼·ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã—ã‚ˆã†
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* å·¦ã‚«ãƒ©ãƒ  */}
        <div className="lg:col-span-2 space-y-6">
          {/* è·æ¥­ãƒ»ãƒ¬ãƒ™ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="glass-card p-8 min-h-[200px]">
              <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
                <span className="text-3xl">ğŸ‘¤</span>
                <span className="truncate">è·æ¥­ãƒ»ãƒ¬ãƒ™ãƒ«</span>
              </h2>
              <div className="space-y-4">
                <JobSelector
                  jobs={availableJobs}
                  selectedJob={currentBuild.job}
                  onChange={setJob}
                />
                {currentBuild.job && (
                  <LevelInput
                    level={currentBuild.level}
                    onChange={setLevel}
                    maxLevel={currentBuild.job.maxLevel}
                  />
                )}
              </div>
            </div>

            {/* SPå‰²ã‚ŠæŒ¯ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
            {currentBuild.job && (
              <div className="glass-card p-8 min-h-[300px]">
                <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
                  <span className="text-3xl">ğŸ“Š</span>
                  <span className="truncate">SPå‰²ã‚ŠæŒ¯ã‚Š</span>
                </h2>
                <SPSlider
                  spValues={{
                    A: currentBuild.spAllocation?.A || 0,
                    B: currentBuild.spAllocation?.B || 0,
                    C: currentBuild.spAllocation?.C || 0,
                  }}
                  maxSP={100}
                  onChange={(values) => setSPAllocation(values)}
                />
              </div>
            )}

            {/* è£…å‚™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
            <div className="glass-card p-8 min-h-[600px]">
              <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
                <span className="text-3xl">âš”ï¸</span>
                <span className="truncate">è£…å‚™</span>
              </h2>
              <div className="space-y-3">
                {equipmentSlots.map(({ slot, name }) => (
                  <EquipmentSlot
                    key={slot}
                    slot={slot}
                    equipment={currentBuild.equipment[slot] || null}
                    availableEquipment={getFilteredEquipment(slot)}
                    onEquipmentChange={(equipment) => setEquipment(slot, equipment)}
                    disabled={!currentBuild.job}
                  />
                ))}
              </div>
            </div>
          </div>

        {/* å³ã‚«ãƒ©ãƒ  */}
        <div className="space-y-6">
          {/* ãƒãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="glass-card p-8 min-h-[400px]">
              <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
                <span className="text-3xl">âœ¨</span>
                <span className="truncate">ãƒãƒ•åŠ¹æœ</span>
              </h2>
              
              {/* ãƒªãƒ³ã‚°ãƒãƒ• */}
              <div className="mb-4">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={ringOption.enabled}
                    onChange={(e) => setRingOption({ ...ringOption, enabled: e.target.checked })}
                    className="mr-2"
                  />
                  <span className="text-gray-700 dark:text-gray-300">ãƒªãƒ³ã‚°ãƒãƒ•</span>
                </label>
                {ringOption.enabled && (
                  <div className="mt-2 ml-6 p-3 bg-gray-50 dark:bg-gray-700 rounded">
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">ãƒªãƒ³ã‚°è¨­å®š</p>
                    {/* ãƒªãƒ³ã‚°è©³ç´°è¨­å®šã‚’ã“ã“ã«å®Ÿè£… */}
                    <select className="w-full px-3 py-2 border rounded bg-white dark:bg-gray-600">
                      <option>æ”»æ’ƒãƒªãƒ³ã‚° Lv1</option>
                      <option>é­”æ³•ãƒªãƒ³ã‚° Lv1</option>
                      <option>é˜²å¾¡ãƒªãƒ³ã‚° Lv1</option>
                    </select>
                  </div>
                )}
              </div>

              {/* Foodãƒãƒ• */}
              <div>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={foodEnabled}
                    onChange={(e) => toggleFood(e.target.checked)}
                    className="mr-2"
                  />
                  <span className="text-gray-700 dark:text-gray-300">é£Ÿã¹ç‰©ãƒãƒ•</span>
                </label>
                {foodEnabled && (
                  <div className="mt-2 ml-6">
                    <select
                      className="w-full px-3 py-2 border rounded bg-white dark:bg-gray-600"
                      value={selectedFood?.id || ''}
                      onChange={(e) => {
                        const food = availableFoods.find(f => f.id === e.target.value);
                        setFood(food || null);
                      }}
                    >
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      {availableFoods.map(food => (
                        <option key={food.id} value={food.id}>{food.name}</option>
                      ))}
                    </select>
                  </div>
                )}
              </div>
            </div>

          {/* é«˜åº¦ãªè¨­å®š */}
          <div className="glass-card p-8 min-h-[200px]">
              <button
                onClick={() => setShowAdvancedSettings(!showAdvancedSettings)}
                className="flex items-center justify-between w-full text-left"
              >
                <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2 truncate">
                  <span className="text-3xl">âš™ï¸</span>
                  <span>é«˜åº¦ãªè¨­å®š</span>
                </h2>
                <span className="text-gray-400 text-2xl">
                  {showAdvancedSettings ? 'â–¼' : 'â–¶'}
                </span>
              </button>
              
              {showAdvancedSettings && (
                <div className="mt-4 space-y-4">
                  {/* æ­¦å™¨å›ºæœ‰èƒ½åŠ› */}
                  <div>
                    <label className="flex items-center">
                      <input
                        type="checkbox"
                        checked={weaponSkillEnabled}
                        onChange={(e) => toggleWeaponSkill(e.target.checked)}
                        className="mr-2"
                      />
                      <span className="text-gray-700 dark:text-gray-300">æ­¦å™¨å›ºæœ‰èƒ½åŠ›</span>
                    </label>
                  </div>

                  {/* æ‰‹å‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª¿æ•´ */}
                  <div>
                    <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      æ‰‹å‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª¿æ•´
                    </h3>
                    <div className="grid grid-cols-2 gap-2">
                      {(['ATK', 'MATK', 'DEF', 'MDEF', 'HP', 'MP'] as const).map(stat => (
                        <div key={stat} className="flex items-center">
                          <label className="text-sm text-gray-600 dark:text-gray-400 w-16">
                            {stat}:
                          </label>
                          <input
                            type="number"
                            className="w-20 px-2 py-1 text-sm border rounded dark:bg-gray-600"
                            value={userOption.manualStats[stat] || 0}
                            onChange={(e) => {
                              const value = parseInt(e.target.value) || 0;
                              setUserOption({
                                ...userOption,
                                manualStats: {
                                  ...userOption.manualStats,
                                  [stat]: value,
                                },
                              });
                            }}
                          />
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>

          {/* æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
          <div className="glass-card p-8 sticky top-24 min-h-[500px] max-h-[800px] overflow-y-auto">
              <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
                <span className="text-3xl">ğŸ“ˆ</span>
                <span className="truncate">æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
              </h2>
              <StatViewer
                stats={calculatedStats}
                showBreakdown={true}
              />
          </div>
      </div>
    </main>
  );
}