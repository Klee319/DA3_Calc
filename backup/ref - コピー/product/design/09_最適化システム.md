# 09_最適化システム

**バージョン**: 1.0
**最終更新日**: 2025-11-22

## 1. システム概要

### 1.1 最適化システムとは

指定された条件下で最大火力を実現する装備・ステータスの組み合わせを自動探索するシステム。

### 1.2 探索の目的

- **装備モード**: 最適な装備の組み合わせを発見
- **ステータスモード**: 最適なSPの振り分けを発見

### 1.3 基本方針

- **探索速度優先**: ユーザー体験を重視し、高速な探索を実現
- **柔軟な固定条件**: ユーザーが特定の装備やステータスを固定可能
- **武器ランクSSS固定**: 最高ランクを前提とした最適化

---

## 2. 探索モード

### 2.1 装備モード

#### 2.1.1 探索対象
- 武器
- 防具（頭、胴、脚）
- アクセサリー（ネックレス、ブレスレット）
- 紋章
- ルーンストーン
- 食べ物バフ

#### 2.1.2 固定条件
ユーザーが以下を指定可能:
- 特定装備スロットの固定（例: 武器を「ウッドソード」に固定）
- 装備ランクの範囲指定（例: SSS〜A のみ）
- 職業装備制限の自動適用

#### 2.1.3 探索範囲
- **使用可能レベル**: キャラクターレベル以下の装備のみ
- **職業制限**: 現在の職業で装備可能な武器種・防具種のみ
- **武器ランク**: **SSS固定**

### 2.2 ステータスモード

#### 2.2.1 探索対象
- SPツリーの振り分け
  - A系統、B系統、C系統への配分
  - 各系統内での段階選択

#### 2.2.2 固定条件
ユーザーが以下を指定可能:
- 特定のSPツリー段階を固定（例: A-5まで必須取得）
- 系統への最低SP投資量（例: B系統に最低10SP）

#### 2.2.3 探索範囲
- **総SP**: キャラクターレベル × 2
- **系統制約**: 各系統は上から順に取得する必要がある

---

## 3. 固定条件の設定

### 3.1 装備固定

#### 3.1.1 スロット単位での固定
```
┌─────────────────────────────────────┐
│ 固定装備設定                        │
├─────────────────────────────────────┤
│ ☑ 武器を固定                        │
│   └─ [ウッドソード] ▼              │
│                                     │
│ ☐ 頭防具を固定                      │
│ ☐ 胴防具を固定                      │
│ ☐ 脚防具を固定                      │
│ ☐ ネックレスを固定                  │
│ ☐ ブレスレットを固定                │
│ ☐ 紋章を固定                        │
└─────────────────────────────────────┘
```

#### 3.1.2 ランク範囲の指定
```
┌─────────────────────────────────────┐
│ ランク範囲設定                      │
├─────────────────────────────────────┤
│ 防具ランク: [SSS] 〜 [A]            │
│ アクセサリーランク: [SSS] 〜 [B]    │
│                                     │
│ ※武器ランクはSSS固定                │
└─────────────────────────────────────┘
```

### 3.2 ステータス固定

#### 3.2.1 SP固定
```
┌─────────────────────────────────────┐
│ SP固定設定                          │
├─────────────────────────────────────┤
│ ☑ A系統を固定                       │
│   └─ A-5まで取得                   │
│                                     │
│ ☐ B系統を固定                       │
│ ☐ C系統を固定                       │
└─────────────────────────────────────┘
```

### 3.3 武器ランク固定

**重要**: 武器ランクは**SSS固定**

**理由**:
- 最高ランクで最適化することで、最大火力を保証
- 探索空間を削減し、計算速度を向上

**UI表示**:
```
武器ランク: SSS (固定)
```

---

## 4. 探索アルゴリズム

### 4.1 アルゴリズムの選択基準

**探索速度優先**: 実装時に以下のいずれかを選択

#### 4.1.1 総当たり探索
- **概要**: すべての組み合わせを網羅的に評価
- **メリット**: 確実に最適解を発見
- **デメリット**: 組み合わせ数が多い場合に時間がかかる
- **適用条件**: 組み合わせ数が10,000以下の場合

#### 4.1.2 ヒューリスティック探索
- **概要**: 遺伝的アルゴリズムや焼きなまし法などを使用
- **メリット**: 大規模な探索空間でも高速
- **デメリット**: 最適解の保証はない（準最適解）
- **適用条件**: 組み合わせ数が10,000を超える場合

### 4.2 探索の優先順位

**火力への影響度順に探索**:
1. 武器（ランクSSS固定）
2. 紋章（%補正が大きい）
3. アクセサリー
4. 防具
5. ルーンストーン
6. 食べ物バフ

### 4.3 探索の打ち切り条件

**最大実行時間**: 30秒
- 30秒経過後は、それまでに見つかった最良の結果を返す
- タイムアウト時にはユーザーに通知

**組み合わせ数の上限**: 1,000,000通り
- 1,000,000通りを超える場合は、ヒューリスティック探索に自動切り替え

---

## 5. 結果表示

### 5.1 表示形式

#### 5.1.1 最適解の表示
```
┌─────────────────────────────────────┐
│ 最適化結果（装備モード）            │
├─────────────────────────────────────┤
│ 最大ダメージ: 1,250                 │
│                                     │
│ 【推奨装備】                        │
│ 武器: ウッドソード (SSS)            │
│ 頭: レザーヘルム (SSS)              │
│ 胴: レザーアーマー (SS)             │
│ 脚: レザーブーツ (S)                │
│ ネックレス: パワーネックレス (SSS)  │
│ ブレスレット: スピードリング (A)    │
│ 紋章: 戦士の紋章                    │
│ 食べ物: 焼き肉                      │
│                                     │
│ ルーンストーン:                     │
│ ├─ ノーマル: 火のルーン             │
│ ├─ グレート: 力のルーン             │
│ └─ バスター: 攻撃のルーン           │
│                                     │
│ [この装備を適用]                    │
└─────────────────────────────────────┘
```

#### 5.1.2 上位結果の一覧表示
```
┌─────────────────────────────────────┐
│ 上位10件の結果                      │
├─────────────────────────────────────┤
│ 1位: ダメージ 1,250  [詳細]        │
│ 2位: ダメージ 1,245  [詳細]        │
│ 3位: ダメージ 1,240  [詳細]        │
│ 4位: ダメージ 1,235  [詳細]        │
│ 5位: ダメージ 1,230  [詳細]        │
│ ...                                 │
│ 10位: ダメージ 1,200 [詳細]        │
└─────────────────────────────────────┘
```

### 5.2 詳細情報

**各結果の詳細表示**:
- 装備の完全リスト
- ステータス内訳
- ダメージ計算の詳細
- 強化値、叩き、錬金の状態

### 5.3 結果のエクスポート

**対応形式**:
- JSON（プログラマブル）
- CSV（スプレッドシート向け）
- URL（共有用）

---

## 6. UI仕様

### 6.1 最適化ページのレイアウト

```
┌─────────────────────────────────────┐
│ 【最適化】                          │
├─────────────────────────────────────┤
│ ビルド読み込み                      │
│ └─ 現在のビルド: ノービス Lv20     │
│                                     │
│ 探索モード                          │
│ ○ 装備モード ○ ステータスモード    │
│                                     │
├─────────────────────────────────────┤
│ 固定条件設定                        │
├─────────────────────────────────────┤
│ [装備固定] [ランク範囲] [SP固定]   │
│                                     │
│ 武器ランク: SSS (固定)              │
│                                     │
├─────────────────────────────────────┤
│ 敵パラメータ（火力計算用）          │
├─────────────────────────────────────┤
│ 防御力: [100]                       │
│ 種族耐性: [20] %                    │
│ 属性耐性: [10] %                    │
│                                     │
├─────────────────────────────────────┤
│ 会心オプション                      │
│ ○ 会心100% ○ 会心0% ● 期待値       │
│                                     │
│ ダメージ補正                        │
│ ○ 最小 ○ 最大 ● 平均               │
│                                     │
├─────────────────────────────────────┤
│ [最適化実行]  推定時間: 約5秒       │
└─────────────────────────────────────┘
```

### 6.2 進捗表示

**探索中の表示**:
```
┌─────────────────────────────────────┐
│ 最適化実行中...                     │
├─────────────────────────────────────┤
│ ▓▓▓▓▓▓▓▓▓▓▓░░░░░ 65%               │
│                                     │
│ 評価済み: 6,500 / 10,000            │
│ 経過時間: 3.2秒                     │
│ 推定残り時間: 1.8秒                 │
│                                     │
│ 現在の最良解: ダメージ 1,245        │
│                                     │
│ [キャンセル]                        │
└─────────────────────────────────────┘
```

### 6.3 結果の適用

**適用ボタン**:
- 最適化結果をキャラビルドページに自動反映
- 確認ダイアログを表示

**確認ダイアログ**:
```
┌─────────────────────────────────────┐
│ この装備を適用しますか?             │
├─────────────────────────────────────┤
│ 現在の装備が上書きされます。        │
│                                     │
│ [適用する] [キャンセル]             │
└─────────────────────────────────────┘
```

---

## 7. バリデーション

### 7.1 探索前のチェック

| 項目 | 条件 | エラー処理 |
|:---|:---|:---|
| キャラクターレベル | 1以上 | エラーメッセージ表示 |
| 職業選択 | 職業が選択済み | エラーメッセージ表示 |
| 敵パラメータ | 数値範囲内 | 入力欄を赤枠表示 |

### 7.2 探索中のチェック

| 項目 | 条件 | 対処方法 |
|:---|:---|:---|
| タイムアウト | 30秒以内 | 現在の最良解を返す |
| メモリ不足 | ブラウザのメモリ制限 | 探索を中断、エラー表示 |

---

## 8. パフォーマンス最適化

### 8.1 キャッシュ戦略

**計算結果のキャッシュ**:
- 同じ装備組み合わせのダメージは再計算しない
- ハッシュマップで管理

### 8.2 並列処理

**Web Workers の活用**:
- メインスレッドをブロックせずに探索
- UIの応答性を維持

### 8.3 探索の枝刈り

**不要な組み合わせのスキップ**:
- 明らかに劣る組み合わせは評価しない
- 例: 低ランク装備のみの組み合わせ

---

## 9. 実装時の注意点

### 9.1 アルゴリズムの選択

**実装時に判断**:
- 装備データの規模を確認
- パフォーマンステストを実施
- 総当たりとヒューリスティックのどちらが適切か判断

### 9.2 拡張性

**将来的な機能追加**:
- 複数の目標設定（例: DPS最大、MP効率最大）
- 制約条件の追加（例: 総コスト制限）
- 探索アルゴリズムの切り替え機能

### 9.3 エラーハンドリング

**想定されるエラー**:
- タイムアウト
- メモリ不足
- 無効な固定条件（例: 矛盾する制約）

---

## 10. テストケース

### 10.1 基本テスト

| テストケース | 期待結果 |
|:---|:---|
| 固定条件なしで探索 | 全装備を考慮した最適解 |
| 武器を固定して探索 | 固定武器を含む最適解 |
| ランク範囲を制限して探索 | 指定範囲内の最適解 |

### 10.2 境界値テスト

| テストケース | 期待結果 |
|:---|:---|
| レベル1での探索 | 使用可能な装備が限定される |
| SPが0での探索（ステータスモード） | 初期値のみで最適化 |

### 10.3 パフォーマンステスト

| テストケース | 目標時間 |
|:---|:---|
| 装備数100件での探索 | 5秒以内 |
| 装備数1000件での探索 | 30秒以内 |

---

## 11. 改訂履歴

| 版 | 日付 | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 1.0 | 2025-11-22 | 初版作成 | Claude |
