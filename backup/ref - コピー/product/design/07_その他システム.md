# 07_その他システム

**バージョン**: 1.0
**最終更新日**: 2025-11-22

## 1. 食べ物バフシステム

### 1.1 食べ物バフとは

一時的にステータスを強化するアイテム。

### 1.2 食べ物CSVの構造

| 列名 | 型 | 説明 |
|:---|:---|:---|
| アイテム名 | string | 食べ物の名称 |
| ステータス | number | 力/魔力/体力など |

**例**:
```csv
アイテム名,力,魔力,体力,精神
焼き肉,10,0,5,0
魔法のパン,0,15,0,5
```

### 1.3 効果の適用方法

**重要**: 食べ物のステータスは**固定値**として加算される。

**計算式**:
```
BaseStatus = (SumEquipment + Job.Initial×Lv + Job.SP + Food + UserOption) × (...)
```

**例**:
- 焼き肉: 力+10, 体力+5
- 適用前の力: 100
- 適用後の力: 100 + 10 = 110（%補正前）

### 1.4 同時使用の制限

**重要**: 食べ物バフは**1つのみ**選択可能。

**UI仕様**:
- ラジオボタンまたはドロップダウンで1つだけ選択
- 「なし」オプションも含める

### 1.5 UI仕様

```
┌─────────────────────────────────────┐
│ 食べ物バフ                          │
│ ┌────────────────┐                  │
│ │ 焼き肉         │ ▼               │
│ └────────────────┘                  │
│                                     │
│ 効果:                               │
│ ├─ 力: +10                          │
│ └─ 体力: +5                         │
└─────────────────────────────────────┘
```

**トグル方式の代替**:
```
┌─────────────────────────────────────┐
│ ☑ 食べ物バフON                      │
│                                     │
│ [焼き肉を選択中]                    │
│ 力: +10  体力: +5                   │
└─────────────────────────────────────┘
```

### 1.6 バリデーション

**同時選択の防止**:
- UI上で1つのみ選択可能にする
- システム側でも検証（2つ以上選択されている場合はエラー）

## 2. リングシステム

### 2.1 現状

**重要**: リングは**未実装**だが、システムとして考慮する必要がある。

### 2.2 リングの仕様（予定）

#### 2.2.1 装備数
- **1個のみ**装備可能

#### 2.2.2 効果
リングは%補正を提供し、収束計算により適用される。

#### 2.2.3 収束計算

**計算式**:
```
repeat(
    round( CurrentStatus × (1 + Ring.<Stat>/100) ),
    until_converged
)
```

**詳細は「02_ステータスシステム.md」の2.8を参照**。

#### 2.2.4 収束条件
- 計算結果が変化しなくなるまで繰り返す
- 最大反復回数: 100回（無限ループ防止）

### 2.3 UI仕様（予定）

```
┌─────────────────────────────────────┐
│ ☑ リングバフON                      │
│                                     │
│ リング選択:                         │
│ ┌────────────────┐                  │
│ │ パワーリング   │ ▼               │
│ └────────────────┘                  │
│                                     │
│ 効果:                               │
│ ├─ 力: +10%                         │
│ └─ 魔力: +5%                        │
│                                     │
│ ※ 収束計算により実際の効果は異なります│
└─────────────────────────────────────┘
```

### 2.4 実装時の考慮事項

#### 2.4.1 データ構造
- リングCSVの作成が必要
- 構造:
  | 列名 | 型 | 説明 |
  |:---|:---|:---|
  | アイテム名 | string | リングの名称 |
  | ステータス(%) | number | 力/魔力/体力など（%） |

#### 2.4.2 収束計算の実装
- 反復計算ロジック
- 収束判定（前回値と同じ場合）
- 最大反復回数制限

#### 2.4.3 UI実装
- トグルスイッチ
- リング選択ドロップダウン
- 収束後の効果表示

## 3. 耐性システム

### 3.1 耐性の種類

#### 3.1.1 種族耐性
- 物理耐性
- 魔法耐性
- 無耐性

#### 3.1.2 属性耐性
- 炎耐性
- 水耐性
- 風耐性
- 雷耐性
- 闇耐性
- 光耐性

### 3.2 耐性の定義元

#### 3.2.1 職業CSV
```csv
解法段階,...,物理耐性,魔耐性,無耐性,炎耐性,水耐性,風耐性,雷耐性,闇耐性,光耐性
A-22,...,,,,,,,5,5
```

**意味**: A-22を取得すると、闇耐性+5%、光耐性+5%

#### 3.2.2 ルーンストーンCSV
```csv
アイテム名,グレード,...,耐性1,耐性2,耐性3,耐性4,耐性5,耐性6
ルーン1,ノーマル,...,"水, 15","火, 10",,,,,
```

**意味**: 水耐性+15%、火耐性+10%

### 3.3 火力計算への影響

**重要**: 耐性は**自分の耐性**なので、**火力計算には考慮しない**。

**理由**:
- 火力計算は「敵に与えるダメージ」を算出するもの
- 自分の耐性は「敵から受けるダメージ」に影響
- 両者は独立

### 3.4 耐性の用途

#### 3.4.1 被ダメージ計算（将来的拡張）
```
ReceivedDamage = EnemyDamage × (1 - TypeResistance/100) × (1 - AttributeResistance/100)
```

#### 3.4.2 ステータス表示
- キャラビルドページで表示
- 装備やSPによる耐性の変化を確認

### 3.5 UI仕様

```
┌─────────────────────────────────────┐
│ 耐性                                │
├─────────────────────────────────────┤
│ 物理耐性: 10%                       │
│ 魔法耐性: 5%                        │
│ 無耐性: 0%                          │
├─────────────────────────────────────┤
│ 炎耐性: 5%                          │
│ 水耐性: 15%                         │
│ 風耐性: 0%                          │
│ 雷耐性: 5%                          │
│ 闇耐性: 5%                          │
│ 光耐性: 5%                          │
└─────────────────────────────────────┘
```

**内訳ツールチップ**:
```
水耐性: 15%
┣━ ルーンストーン「ルーン1」: +15%
┗━ 職業SP: +0%
```

## 4. その他のゲーム要素

### 4.1 コンボシステム

#### 4.1.1 フライパン専用
```yaml
Frypan:
  BasedDamage: "round((WeaponAttackPower + UserPower × 1.6) × DamageCorrection × ComboCorrection × (1 + WeaponCritDamage/100 + UserCritDamage × 0.005)) / 2"
```

**ComboCorrection**:
- フライパン専用の変数
- 現時点では定義なし（デフォルト: 1）

#### 4.1.2 将来的な実装
- コンボ数によるダメージ増加
- UI上でコンボ数を入力

### 4.2 敵パラメータ

#### 4.2.1 火力計算ページで入力

| パラメータ | 説明 | 範囲 |
|:---|:---|:---|
| 敵防御力 | EnemyDefence | 0〜999999 |
| 種族耐性 | EnemyTypeResistance | 0〜100（%） |
| 属性耐性 | EnemyAttributeResistance | 0〜100（%） |
| 敵HP | 敵の最大HP（任意） | 0〜999999 |

#### 4.2.2 用途
- 最終ダメージ計算（FinalDamage）
- TTK（Time To Kill / 敵撃破までのヒット数）計算

### 4.3 DPS・TTK計算

#### 4.3.1 DPS（Damage Per Second）
```
DPS = FinalDamage / CT
```

**例**:
- FinalDamage: 1000
- CT: 1.2秒
- DPS: 833.3

#### 4.3.2 TTK（Time To Kill）
```
TTK = ceil(EnemyHP / FinalDamage)
```

**例**:
- EnemyHP: 10000
- FinalDamage: 684
- TTK: ceil(10000 / 684) = 15ヒット

#### 4.3.3 撃破時間
```
KillTime = TTK × CT
```

**例**:
- TTK: 15ヒット
- CT: 1.2秒
- KillTime: 18秒

### 4.4 MP効率

```
MP効率 = FinalDamage / SkillMP
```

**例**:
- FinalDamage: 1000
- SkillMP: 40
- MP効率: 25 ダメージ/MP

**用途**:
- スキルのコストパフォーマンス比較

## 5. データ拡張性

### 5.1 新規食べ物の追加
- CSVに行を追加するのみ
- システム側の変更は不要

### 5.2 新規リングの追加（実装後）
- CSVに行を追加するのみ
- システム側の変更は不要

### 5.3 新規耐性の追加
- 影響範囲:
  - CSVカラムの追加
  - UI表示項目の追加
  - 被ダメージ計算ロジックの更新（将来的拡張）

## 6. バリデーション

### 6.1 食べ物バフ
- 1つのみ選択されているか
- 選択された食べ物が存在するか

### 6.2 リング（実装後）
- 1つのみ選択されているか
- 収束計算が正常に終了したか

### 6.3 敵パラメータ
- 数値範囲内か
- 負の値でないか

## 7. 最適化システム概要

### 7.1 最適化ページの位置づけ

**詳細は「09_最適化システム.md」を参照**

最適化システムは、指定された条件下で最大火力を実現する装備・ステータス組み合わせを探索する機能です。

### 7.2 基本仕様

#### 7.2.1 探索モード
- **装備モード**: 装備の組み合わせを最適化
- **ステータスモード**: SPの振り分けを最適化

#### 7.2.2 固定条件
ユーザーが以下を指定可能:
- 特定装備の固定
- ステータス値の固定
- 武器ランク: **SSS固定**

#### 7.2.3 探索アルゴリズム
- **探索速度優先**: 早いほうを採用
  - 総当たり探索
  - ヒューリスティック探索
  - 実装時にパフォーマンスを考慮して判断

### 7.3 UI構成

```
┌─────────────────────────────────────┐
│ 最適化条件設定                      │
├─────────────────────────────────────┤
│ モード選択:                         │
│ ○ 装備モード ○ ステータスモード    │
│                                     │
│ 固定条件:                           │
│ ☐ 武器を固定: [ウッドソード]       │
│ ☐ 力を固定: [100]                  │
│                                     │
│ 武器ランク: SSS (固定)              │
│                                     │
│ [最適化実行]                        │
└─────────────────────────────────────┘
```

## 8. 改訂履歴

| 版 | 日付 | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 1.1 | 2025-11-22 | 最適化システム概要を追加 | Claude |
| 1.0 | 2025-11-22 | 初版作成 | Claude |
