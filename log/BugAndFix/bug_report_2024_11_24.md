# 不具合調査報告書
作成日: 2024/11/24

## 不具合・エラーの概要

### 報告された不具合
1. **仕様書通りの機能が実装されていない**
   - モックデータが残っている
   - CSVやYAMLで設定された式がフロントエンドに反映されていない
   - 装備品のカスタムがUI/UXの指示書通りにできていない

2. **スクロールバーやプルダウンのデザイン問題**
   - デザインが洗練されていない（selectmenuのようなお洒落なコンポーネントを希望）

3. **職業選択プルダウンの表示問題**
   - SP割り振り欄が非表示の時、プルダウンメニューが装備コンポーネントの裏側に隠れる
   - 透明度が高すぎる可能性

## 考察した原因

### 1. データ連携に関する根本原因

#### CSVファイルとYAMLファイルの連携不備
- **CSV/YAML読み込み機能は実装済み**
  - `src/lib/data/csvLoader.ts`と`src/lib/data/yamlLoader.ts`が存在
  - CSVファイル（武器、防具、アクセサリー、紋章、ルーンストーン、食べ物、職業）は正しく配置されている
  - YAMLファイル（EqConst, JobConst, UserStatusCalc, WeaponCalc, SkillCalc）も存在

- **問題点：データ変換とマッピングの不完全実装**
  - `src/app/build/page.tsx`（86-96行目）で職業データが**ハードコーディング**されている
  - CSVから読み込んだデータの多くが**未使用または変換ロジックが不完全**
  - 仕様書で定義されている計算式（UserStatusCalc.yaml）が**実際の計算に使用されていない**

### 2. UIコンポーネントの実装不備

#### CustomSelectコンポーネントの実装状況
- **CustomSelectは実装済み**（`src/components/CustomSelect.tsx`）
  - 独自のドロップダウンコンポーネントを実装
  - アニメーション付きで表示される
  - アイコン、説明文の表示にも対応

- **問題点：z-indexとポジショニング**
  - ドロップダウンメニューのz-indexが`z-50`と設定されているが、他のコンポーネントとの重なりで問題発生
  - SP割り振り欄が非表示の際のレイアウトシフトによる表示崩れ

### 3. 装備品カスタマイズ機能の未実装

- **仕様書で定義されている機能が未実装**
  - 装備のランク（F〜SSS）システム
  - 叩き回数（0〜12）システム
  - 強化・クオリティシステム
  - EXステータスシステム

## 実際に修正すべき原因

### 優先度：高

1. **CSVデータの正しい活用**
   - 職業データのハードコーディング部分を削除
   - CSVから読み込んだ実データを使用するように修正

2. **YAMLの計算式の適用**
   - UserStatusCalc.yamlの計算式を実際の計算に使用
   - 装備ランク計算、叩き、強化などの実装

3. **職業選択プルダウンのz-index問題**
   - CustomSelectのz-indexを調整
   - ポジショニング戦略の見直し（absolute → fixed など）

### 優先度：中

4. **装備カスタマイズUIの追加**
   - ランク選択機能
   - 叩き回数の設定UI
   - 強化レベル入力欄

5. **ステータス計算の正確な実装**
   - プレースホルダーマッピング（spec-placeholder-mapping.md）に従った変数名の統一
   - 防具・アクセサリーのEXステータス計算

### 優先度：低

6. **UIデザインの洗練**
   - スクロールバーのカスタマイズ強化
   - アニメーションの追加

## 修正内容と修正箇所

### 1. 職業データのハードコーディング削除
**対象ファイル**: `src/app/build/page.tsx`
- 60-96行目の職業データ変換ロジックを修正
- CSVから読み込んだ実データを正しく変換する

### 2. 計算ロジックの実装
**対象ファイル**:
- `src/lib/calc/statusCalculator.ts`（新規作成または既存修正）
- `src/lib/calc/equipmentCalculator.ts`（既存修正）

### 3. CustomSelectのz-index修正
**対象ファイル**: `src/components/CustomSelect.tsx`
- 193行目のz-indexを`z-[100]`または`z-[9999]`に変更
- position戦略の見直し

### 4. 装備カスタマイズUIコンポーネントの追加
**対象ファイル**:
- `src/components/EquipmentSlot.tsx`（修正）
- 新規コンポーネント作成（EquipmentCustomizer.tsx）

## 推奨される実装順序

1. **Phase 1: データ連携の修正**（最優先）
   - CSVデータの正しい読み込みと変換
   - モックデータの完全削除

2. **Phase 2: UI表示問題の修正**
   - 職業選択プルダウンの表示問題解決
   - z-indexとポジショニングの調整

3. **Phase 3: 計算ロジックの実装**
   - YAMLファイルの計算式適用
   - ステータス計算の正確な実装

4. **Phase 4: 装備カスタマイズ機能**
   - ランク、叩き、強化システムの実装
   - UIコンポーネントの追加

5. **Phase 5: デザインの洗練**
   - スクロールバーやアニメーションの改善

## 技術的な課題と制約

1. **データ構造の複雑性**
   - 仕様書の計算式が複雑で、実装には段階的なアプローチが必要

2. **パフォーマンスへの配慮**
   - 装備の組み合わせ計算が多いため、最適化が必要

3. **テストの必要性**
   - 計算ロジックの正確性を保証するためのユニットテストが必要